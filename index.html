<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>App Catalog</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <h1 class="logo">App Catalog</h1>
      <input id="search" placeholder="Search apps, developers..." />
    </div>
  </header>

  <main class="container">
    <section id="counts" class="counts">0 apps</section>

    <div id="grid" class="grid"></div>
  </main>

  <!-- App detail modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-hidden="true">
    <div class="modal-panel">
      <button id="modalClose" class="close-btn">✕</button>
      <div class="modal-body">
        <img id="modalIcon" class="app-icon" src="" alt="">
        <div class="app-meta">
          <h2 id="modalTitle"></h2>
          <p id="modalDev" class="muted"></p>
          <p id="modalVer" class="muted"></p>
          <p id="modalDesc"></p>
          <div class="modal-actions">
            <a id="downloadBtn" class="btn" target="_blank" rel="noopener">Download .ipa</a>
            <a id="installBtn" class="btn secondary" target="_blank" rel="noopener">Install (OTA)</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer container">
    <small>Made with ♥ — Replace apps in <code>script.js</code></small>
  </footer>

  <script src="script.js"></script>
  <script>
    // Main renderer (keeps index.html simple)
    (function(){
      const apps = window.APPS || [];
      const grid = document.getElementById('grid');
      const counts = document.getElementById('counts');
      const search = document.getElementById('search');

      const modal = document.getElementById('modal');
      const modalClose = document.getElementById('modalClose');
      const modalIcon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalDev = document.getElementById('modalDev');
      const modalVer = document.getElementById('modalVer');
      const modalDesc = document.getElementById('modalDesc');
      const downloadBtn = document.getElementById('downloadBtn');
      const installBtn = document.getElementById('installBtn');

      function render(filtered) {
        grid.innerHTML = '';
        counts.textContent = filtered.length + (filtered.length === 1 ? ' app' : ' apps');
        if (!filtered.length) {
          grid.innerHTML = '<div class="empty">No apps found.</div>';
          return;
        }
        filtered.forEach(app => {
          const card = document.createElement('article');
          card.className = 'card';
          card.innerHTML = `
            <img class="card-icon" src="${app.icon || 'default-icon.png'}" alt="">
            <div class="card-body">
              <h3 class="card-title">${escapeHtml(app.name)}</h3>
              <p class="card-sub">${escapeHtml(app.developer || '')}</p>
            </div>
            <div class="card-actions">
              <button class="btn small" data-id="${app.id}" data-action="open">Details</button>
              <a class="btn small" href="${app.ipa_url}" target="_blank" rel="noopener" download>Download</a>
            </div>
          `;
          grid.appendChild(card);

          card.querySelector('[data-action="open"]').addEventListener('click', () => openModal(app));
        });
      }

      function openModal(app) {
        modalIcon.src = app.icon || 'default-icon.png';
        modalTitle.textContent = app.name;
        modalDev.textContent = app.developer ? 'By ' + app.developer : '';
        modalVer.textContent = app.version ? 'Version: ' + app.version : '';
        modalDesc.textContent = app.description || '';
        downloadBtn.href = app.ipa_url || '#';
        // Build an OTA manifest link if manifest_url is provided
        if (app.manifest_url) {
          installBtn.href = `itms-services://?action=download-manifest&url=${encodeURIComponent(app.manifest_url)}`;
          installBtn.style.display = 'inline-block';
        } else {
          // as fallback we will provide the ipa link and hide OTA
          installBtn.href = app.ipa_url || '#';
          installBtn.style.display = 'inline-block';
        }
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      }

      modalClose.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
      });

      // search
      function filter(q){
        q = (q || '').toLowerCase().trim();
        if (!q) return apps.slice();
        return apps.filter(a => {
          return (a.name||'').toLowerCase().includes(q)
              || (a.developer||'').toLowerCase().includes(q)
              || (a.description||'').toLowerCase().includes(q);
        });
      }

      search.addEventListener('input', e => render(filter(e.target.value)));
      // initial render
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
      window.escapeHtml = escapeHtml;

      render(apps);
    })();
  </script>
</body>
</html>
